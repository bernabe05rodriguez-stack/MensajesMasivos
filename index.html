<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creador de Mensajes - MAVERIX</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #0a0a0a;
            color: #d4d4d4;
            min-height: 100vh;
        }
        .container { max-width: 1000px; margin: 0 auto; padding: 24px 20px; }

        /* Header */
        .header {
            text-align: center;
            padding: 32px 0 28px;
        }
        .header h1 {
            font-size: 1.4rem;
            font-weight: 300;
            color: #a3a3a3;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        .header .brand {
            font-size: 2.4rem;
            font-weight: 700;
            color: #ffffff;
            letter-spacing: 6px;
            margin-top: 2px;
        }

        /* Steps */
        .step {
            background: #141414;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 14px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.4);
            transition: opacity 0.3s;
        }
        .step.disabled { opacity: 0.3; pointer-events: none; }
        h2 {
            font-size: 0.85rem;
            font-weight: 500;
            color: #525252;
            margin-bottom: 14px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        /* Upload */
        .upload-area {
            border: 1px dashed #333;
            border-radius: 12px;
            padding: 44px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover, .upload-area.dragover {
            border-color: #fff;
            background: rgba(255,255,255,0.02);
        }
        .upload-area.hidden { display: none; }
        .upload-area input { display: none; }
        .upload-area p { color: #525252; font-size: 0.9rem; }
        .upload-icon { font-size: 2rem; margin-bottom: 10px; opacity: 0.4; }

        .file-loaded {
            display: none;
            padding: 16px 20px;
            background: #1a1a1a;
            border-radius: 10px;
            animation: fadeIn 0.4s ease-out;
        }
        .file-loaded.show { display: flex; align-items: center; gap: 14px; }
        .file-loaded .file-name { flex: 1; color: #4ade80; font-weight: 600; font-size: 0.95rem; }
        .file-loaded .file-stats { color: #525252; font-size: 0.8rem; }
        .btn-remove {
            background: transparent; color: #ef4444; border: 1px solid #ef4444;
            padding: 6px 14px; border-radius: 8px; cursor: pointer;
            font-size: 0.8rem; font-weight: 500; transition: all 0.2s;
        }
        .btn-remove:hover { background: #ef4444; color: #fff; }

        .loading-overlay { display: none; padding: 44px; text-align: center; }
        .loading-overlay.show { display: block; }
        .spinner {
            width: 40px; height: 40px;
            border: 3px solid #222; border-top-color: #fff;
            border-radius: 50%; animation: spin 0.7s linear infinite;
            margin: 0 auto 14px;
        }
        .loading-overlay p { color: #525252; font-size: 0.85rem; }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }

        /* Toggle chips (phone cols & column selector) */
        .chip-group { display: flex; flex-wrap: wrap; gap: 6px; }
        .chip {
            padding: 7px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.82rem;
            border: 1px solid #262626;
            background: #1a1a1a;
            color: #525252;
            transition: all 0.2s;
            user-select: none;
        }
        .chip:hover { border-color: #404040; }
        .chip.active {
            background: #fff;
            color: #0a0a0a;
            border-color: #fff;
            font-weight: 600;
            box-shadow: 0 2px 12px rgba(255,255,255,0.1);
        }
        .chip .chip-count { opacity: 0.5; margin-left: 4px; font-size: 0.75rem; }

        /* Message template */
        .msg-area { display: flex; gap: 12px; flex-wrap: wrap; }
        .msg-area textarea {
            flex: 1; min-width: 280px; min-height: 110px;
            background: #1a1a1a; color: #d4d4d4;
            border: 1px solid #262626; border-radius: 10px;
            padding: 14px; font-family: inherit; font-size: 0.9rem; resize: vertical;
        }
        .msg-area textarea:focus { outline: none; border-color: #404040; }
        .variables-panel {
            min-width: 200px; max-height: 240px; overflow-y: auto;
            background: #1a1a1a; border-radius: 10px; padding: 10px; border: 1px solid #262626;
        }
        .variables-panel p { font-size: 0.75rem; color: #404040; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 1px; }
        .var-btn {
            display: inline-block; background: #262626; color: #737373;
            border: none; padding: 4px 10px; border-radius: 6px; margin: 2px;
            cursor: pointer; font-size: 0.78rem; transition: all 0.15s;
        }
        .var-btn:hover { background: #333; color: #fff; }
        .var-btn.money { border-left: 2px solid #4ade80; }

        .msg-preview {
            margin-top: 10px; padding: 14px; background: #1a1a1a;
            border-radius: 10px; border: 1px solid #262626;
            font-size: 0.85rem; color: #525252; white-space: pre-wrap;
        }
        .msg-preview strong { color: #fff; }
        .hint { font-size: 0.8rem; color: #404040; margin-bottom: 10px; }
        .hint code { color: #737373; background: #1a1a1a; padding: 1px 5px; border-radius: 4px; }

        /* Stats */
        .stats { font-size: 0.82rem; color: #404040; padding: 6px 0; }
        .stats span { color: #fff; font-weight: 600; }

        /* Buttons */
        .btn {
            padding: 12px 28px; border: none; border-radius: 10px;
            font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;
        }
        .btn-export {
            background: #fff; color: #0a0a0a;
            box-shadow: 0 2px 16px rgba(255,255,255,0.1);
        }
        .btn-export:hover { box-shadow: 0 4px 24px rgba(255,255,255,0.2); transform: translateY(-1px); }

        /* Toast */
        .toast {
            position: fixed; bottom: 24px; right: 24px;
            background: #fff; color: #0a0a0a;
            padding: 12px 24px; border-radius: 10px; font-weight: 600; font-size: 0.9rem;
            transform: translateY(80px); opacity: 0;
            transition: all 0.3s; z-index: 100;
            box-shadow: 0 4px 24px rgba(255,255,255,0.15);
        }
        .toast.show { transform: translateY(0); opacity: 1; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Creador de Mensajes</h1>
            <div class="brand">MAVERIX</div>
        </div>

        <!-- STEP 1: Upload -->
        <div class="step" id="step1">
            <h2>1. Archivo CSV</h2>
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">&#128194;</div>
                <p>Arrastra el archivo <strong>Informe de Cuentas.csv</strong> aca o hace clic</p>
                <input type="file" id="fileInput" accept=".csv,.txt">
            </div>
            <div class="loading-overlay" id="loadingOverlay">
                <div class="spinner"></div>
                <p>Procesando archivo...</p>
            </div>
            <div class="file-loaded" id="fileLoaded">
                <div>
                    <div class="file-name" id="fileName"></div>
                    <div class="file-stats" id="fileStats"></div>
                </div>
                <button class="btn-remove" id="btnRemoveFile">Cambiar archivo</button>
            </div>
        </div>

        <!-- STEP 2: Phone columns -->
        <div class="step disabled" id="step2">
            <h2>2. Columnas de telefono</h2>
            <div class="chip-group" id="phoneCols"></div>
        </div>

        <!-- STEP 3: Message template -->
        <div class="step disabled" id="step3">
            <h2>3. Mensaje personalizado</h2>
            <p class="hint">
                Usa <code>{NombreColumna}</code> para insertar datos. <code>{$ Asig.}</code> y <code>{$ Hist.}</code> se formatean como pesos.
            </p>
            <div class="msg-area">
                <textarea id="msgTemplate" placeholder="Hola {Razon Social}, te contactamos por tu cuenta {Cuenta}. Tu saldo es de {$ Asig.}. Contactanos para regularizar tu situacion."></textarea>
                <div class="variables-panel" id="varsPanel">
                    <p>Variables</p>
                </div>
            </div>
            <div class="msg-preview" id="msgPreview">Vista previa del mensaje...</div>
        </div>

        <!-- STEP 4: Extra columns -->
        <div class="step disabled" id="step4">
            <h2>4. Columnas adicionales en el Excel</h2>
            <p class="hint">El Excel siempre tiene <strong>Telefono</strong> y <strong>Mensaje</strong>. Selecciona columnas extra.</p>
            <div class="chip-group" id="extraColsChips"></div>
        </div>

        <!-- STEP 5: Export -->
        <div class="step disabled" id="step5">
            <h2>5. Exportar</h2>
            <div style="display:flex;gap:14px;flex-wrap:wrap;align-items:center;">
                <button class="btn btn-export" id="btnExportCSV">Descargar CSV</button>
                <div class="stats" id="exportStats"></div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
    (function() {
        let rawData = [];
        let headers = [];
        const phoneColNames = ['Telefono_1','Telefono_2','Telefono_3','Telefono_4','Telefono_5','Telefono_6','Telefono_7','Telefono_8','Telefono_9'];
        let selectedPhoneCols = new Set(phoneColNames);
        let contactRows = [];
        let extraCols = new Set();
        const moneyCols = ['$ Asig.', '$ Hist.'];

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const fileLoaded = document.getElementById('fileLoaded');
        const fileName = document.getElementById('fileName');
        const fileStats = document.getElementById('fileStats');
        const phoneColsEl = document.getElementById('phoneCols');
        const msgTemplate = document.getElementById('msgTemplate');
        const varsPanel = document.getElementById('varsPanel');
        const msgPreview = document.getElementById('msgPreview');
        const exportStats = document.getElementById('exportStats');
        const extraColsChips = document.getElementById('extraColsChips');

        // ========== CSV PARSING ==========
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const ch = line[i];
                if (inQuotes) {
                    if (ch === '"') {
                        if (i + 1 < line.length && line[i + 1] === '"') { current += '"'; i++; }
                        else inQuotes = false;
                    } else current += ch;
                } else {
                    if (ch === '"') inQuotes = true;
                    else if (ch === ';') { result.push(current.trim()); current = ''; }
                    else current += ch;
                }
            }
            result.push(current.trim());
            return result;
        }

        function parseCSV(text) {
            const lines = text.split('\n').map(l => l.replace(/\r$/, '')).filter(l => l.trim());
            if (lines.length < 2) return;
            headers = parseCSVLine(lines[0]);
            rawData = [];
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                const row = {};
                headers.forEach((h, idx) => { row[h] = values[idx] || ''; });
                rawData.push(row);
            }
        }

        function formatPeso(val) {
            const num = parseFloat(val);
            if (isNaN(num)) return val;
            return '$' + num.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // ========== UPLOAD ==========
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('dragover'); });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
        uploadArea.addEventListener('drop', e => {
            e.preventDefault(); uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', () => { if (fileInput.files.length) handleFile(fileInput.files[0]); });
        document.getElementById('btnRemoveFile').addEventListener('click', resetFile);

        function handleFile(file) {
            uploadArea.classList.add('hidden');
            loadingOverlay.classList.add('show');
            const reader = new FileReader();
            reader.onload = e => {
                parseCSV(e.target.result);
                let totalPhones = 0;
                rawData.forEach(row => {
                    phoneColNames.forEach(col => {
                        const val = row[col];
                        if (!val) return;
                        if (col === 'Telefono_1' && val.includes('-')) {
                            totalPhones += val.split('-').filter(n => n.trim()).length;
                        } else totalPhones++;
                    });
                });
                setTimeout(() => {
                    loadingOverlay.classList.remove('show');
                    fileLoaded.classList.add('show');
                    fileName.textContent = file.name;
                    fileStats.textContent = `${rawData.length} registros | ${totalPhones} telefonos`;
                    enableSteps();
                }, 400);
            };
            reader.readAsText(file, 'UTF-8');
        }

        function resetFile() {
            rawData = []; headers = []; extraCols = new Set();
            selectedPhoneCols = new Set(phoneColNames); contactRows = [];
            fileLoaded.classList.remove('show');
            uploadArea.classList.remove('hidden');
            fileInput.value = '';
            ['step2','step3','step4','step5'].forEach(s => document.getElementById(s).classList.add('disabled'));
            phoneColsEl.innerHTML = '';
            varsPanel.innerHTML = '<p>Variables</p>';
            msgPreview.textContent = 'Vista previa del mensaje...';
            extraColsChips.innerHTML = '';
            exportStats.innerHTML = '';
        }

        function enableSteps() {
            ['step2','step3','step4','step5'].forEach(s => document.getElementById(s).classList.remove('disabled'));
            renderPhoneCols();
            renderVariables();
            buildContactRows();
            renderExtraColsChips();
            updatePreview();
        }

        // ========== PHONE COLUMN CHIPS ==========
        function renderPhoneCols() {
            phoneColsEl.innerHTML = '';
            phoneColNames.forEach(col => {
                if (!headers.includes(col)) return;
                let count = 0;
                rawData.forEach(r => {
                    const val = r[col];
                    if (!val) return;
                    if (col === 'Telefono_1' && val.includes('-'))
                        count += val.split('-').filter(n => n.trim()).length;
                    else count++;
                });
                const chip = document.createElement('div');
                chip.className = 'chip' + (count > 0 ? ' active' : '');
                chip.innerHTML = `${col}<span class="chip-count">${count}</span>`;
                if (count === 0) { selectedPhoneCols.delete(col); chip.style.opacity = '0.3'; }
                chip.addEventListener('click', () => {
                    if (count === 0) return;
                    if (selectedPhoneCols.has(col)) {
                        selectedPhoneCols.delete(col);
                        chip.classList.remove('active');
                    } else {
                        selectedPhoneCols.add(col);
                        chip.classList.add('active');
                    }
                    buildContactRows();
                });
                phoneColsEl.appendChild(chip);
            });
        }

        // ========== VARIABLES ==========
        function renderVariables() {
            const frag = document.createDocumentFragment();
            const p = document.createElement('p');
            p.textContent = 'Variables';
            frag.appendChild(p);
            headers.forEach(h => {
                if (phoneColNames.includes(h)) return;
                const btn = document.createElement('button');
                btn.className = 'var-btn' + (moneyCols.includes(h) ? ' money' : '');
                btn.textContent = `{${h}}`;
                btn.addEventListener('click', () => {
                    const ta = msgTemplate;
                    const start = ta.selectionStart, end = ta.selectionEnd;
                    const insert = `{${h}}`;
                    ta.value = ta.value.substring(0, start) + insert + ta.value.substring(end);
                    ta.focus();
                    ta.selectionStart = ta.selectionEnd = start + insert.length;
                    updatePreview();
                });
                frag.appendChild(btn);
            });
            varsPanel.innerHTML = '';
            varsPanel.appendChild(frag);
        }

        msgTemplate.addEventListener('input', updatePreview);
        function updatePreview() {
            if (!rawData.length) return;
            const row = rawData.find(r => phoneColNames.some(c => r[c] && r[c].trim())) || rawData[0];
            let msg = msgTemplate.value || msgTemplate.placeholder;
            msg = msg.replace(/\{([^}]+)\}/g, (m, key) => {
                if (row[key] === undefined) return m;
                const val = moneyCols.includes(key) ? formatPeso(row[key]) : row[key];
                return '<strong>' + escHtml(val) + '</strong>';
            });
            msgPreview.innerHTML = msg || 'Vista previa del mensaje...';
        }

        // ========== CONTACT ROWS ==========
        function buildContactRows() {
            contactRows = [];
            rawData.forEach((row, rowIdx) => {
                selectedPhoneCols.forEach(col => {
                    const val = row[col];
                    if (!val || !val.trim()) return;
                    if (col === 'Telefono_1' && val.includes('-')) {
                        val.split('-').forEach(num => {
                            const clean = num.trim();
                            if (clean) contactRows.push({ rowIdx, row, col, number: clean });
                        });
                    } else {
                        contactRows.push({ rowIdx, row, col, number: val.trim() });
                    }
                });
            });
            updateExportStats();
        }

        function updateExportStats() {
            exportStats.innerHTML = `Se exportaran <span>${contactRows.length}</span> filas`;
        }

        // ========== EXTRA COLUMNS CHIPS (step 4) ==========
        function renderExtraColsChips() {
            extraColsChips.innerHTML = '';
            const skip = new Set(phoneColNames);
            headers.forEach(col => {
                if (skip.has(col)) return;
                const chip = document.createElement('div');
                chip.className = 'chip' + (extraCols.has(col) ? ' active' : '');
                chip.textContent = col;
                chip.addEventListener('click', () => {
                    if (extraCols.has(col)) {
                        extraCols.delete(col);
                        chip.classList.remove('active');
                    } else {
                        extraCols.add(col);
                        chip.classList.add('active');
                    }
                });
                extraColsChips.appendChild(chip);
            });
        }

        // ========== BUILD MESSAGE ==========
        function buildMessage(row) {
            let tpl = msgTemplate.value || msgTemplate.placeholder;
            return tpl.replace(/\{([^}]+)\}/g, (m, key) => {
                if (row[key] === undefined) return m;
                return moneyCols.includes(key) ? formatPeso(row[key]) : row[key];
            });
        }

        // ========== EXPORT ==========
        document.getElementById('btnExportCSV').addEventListener('click', exportCSV);

        function exportCSV() {
            if (!contactRows.length) { showToast('No hay telefonos para exportar'); return; }
            const sep = ';';
            const extraArr = headers.filter(h => extraCols.has(h));
            const headerRow = ['Telefono', 'Mensaje', ...extraArr];
            const lines = [headerRow.map(csvField).join(sep)];

            contactRows.forEach(c => {
                const phone = '="+549' + c.number + ',"';
                const msg = buildMessage(c.row);
                const row = [phone, csvField(msg)];
                extraArr.forEach(col => row.push(csvField(c.row[col] || '')));
                lines.push(row.join(sep));
            });

            const bom = '\uFEFF';
            const blob = new Blob([bom + lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'contactos_mensajes.csv';
            a.click();
            URL.revokeObjectURL(url);
            showToast('CSV descargado con ' + contactRows.length + ' telefonos');
        }

        function csvField(val) {
            val = String(val);
            if (val.includes(';') || val.includes('"') || val.includes('\n'))
                return '"' + val.replace(/"/g, '""') + '"';
            return val;
        }

        function escHtml(str) {
            const d = document.createElement('div');
            d.textContent = str;
            return d.innerHTML;
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
    })();
    </script>
</body>
</html>
